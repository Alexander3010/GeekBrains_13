// Fill out your copyright notice in the Description page of Project Settings.


#include "CommandletGenerateLODs.h"
#include "EditorStaticMeshLibrary.h"
#include "Engine/StaticMesh.h"
#include "AssetRegistry/AssetRegistryModule.h"

int32 UCommandletGenerateLODs::Main(const FString& Params)
{
	TArray<FString> Tokens;
	TArray<FString> Switches;

	ParseCommandLine(*Params, Tokens, Switches);
	// - runModifyAsstets

	if (Switches.Contains(TEXT("GenerateLod")))
	{
		if(Tokens.Num() > 0)
		{
			ProcessAssets(Tokens);
		}
	}
	
	return 0;
}

void UCommandletGenerateLODs::ProcessAssets(TArray<FString> RootDirectories)
{
	FAssetRegistryModule& AssetRegistryModule = FModuleManager::LoadModuleChecked<FAssetRegistryModule>(AssetRegistryConstants::ModuleName);

	AssetRegistryModule.Get().SearchAllAssets(true);
	
	FString ClassName = TEXT("StaticMesh");

	TArray<FAssetData> AssetList;
	AssetRegistryModule.Get().GetAssetsByClass(*ClassName, AssetList, true);

	for (FAssetData& AssetData : AssetList)
	{
		for (FString RootDirectory : RootDirectories)
		{
			if (AssetData.ObjectPath.ToString().StartsWith(RootDirectory, ESearchCase::IgnoreCase))
			{
				UObject* AssetInstance = AssetData.GetAsset();
				
				ModifyLod(AssetInstance);

				SaveAsset(AssetInstance);

				break;
			}
		}
	}
}

void UCommandletGenerateLODs::ModifyLod(UObject* AssetInstance)
{
	if (UStaticMesh* Mesh = Cast<UStaticMesh>(AssetInstance))
	{
		//TArray<FEditorScriptingMeshReductionSettings> ReductionSettings;
		TArray<FStaticMeshReductionSettings> ReductionSettings;

		FStaticMeshReductionSettings Settings;

		//LOD 0
		Settings.PercentTriangles = 1.f;
		Settings.ScreenSize = 0.9f;
		ReductionSettings.Add(Settings);

		//LOD 1
		Settings.PercentTriangles = 0.5f;
		Settings.ScreenSize = 0.5f;
		ReductionSettings.Add(Settings);
		
		//LOD 2
		Settings.PercentTriangles = 0.1f;
        Settings.ScreenSize = 0.3f;
        ReductionSettings.Add(Settings);
		FStaticMeshReductionOptions Options;
		Options.ReductionSettings = ReductionSettings;
		UDEPRECATED_EditorStaticMeshLibrary::SetLods(Mesh, Options);

		AssetInstance->MarkPackageDirty();
	}
}

void UCommandletGenerateLODs::SaveAsset(UObject* AssetInstance)
{
	if (AssetInstance)
	{
		if (UPackage* Package = AssetInstance->GetPackage())
		{
			FString PackageName = FPackageName::LongPackageNameToFilename(Package->GetPathName(), FPackageName::GetAssetPackageExtension());

			UE_LOG(LogClass, Log, TEXT("Saving asset to: %s..."), *PackageName);

			if (Package->SavePackage(Package, AssetInstance, RF_Standalone, *PackageName, GLog))
			{
				UE_LOG(LogClass, Log, TEXT("Saved asset successfully"));
			}
			else
			{
				UE_LOG(LogClass, Warning, TEXT("Failed to save asset to %s."), *PackageName);
			}
		}
	}
}
